import subprocess,os,shutil

input_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
output_dir = os.path.join(os.getenv("TEMP"),"bagman")
try:
    shutil.rmtree(output_dir)
except OSError:
    pass
try:
    os.mkdir(output_dir)
except OSError:
    pass
#data_dir = os.path.join(output_dir,"data")
data_dir = output_dir
try:
    #os.mkdir(data_dir)
    os.mkdir(os.path.join(data_dir,"resource"))
except OSError:
    pass

for d in ["libs","s","c","resource/amiga","resource/maps"]:
    shutil.copytree(os.path.join(input_dir,d),os.path.join(data_dir,d))
try:
    shutil.rmtree(os.path.join(data_dir,"resource/amiga/work"))
except OSError:
    pass

exe ="bagman"
input_exe = os.path.join(input_dir,exe)
try:
    os.remove(input_exe)
except IOError:
    pass

#cmd = ["m68k-amigaos-strip",os.path.join(input_dir,exe),"-o",os.path.join(output_dir,exe)]
cmd = ["gprbuild","-P","bagman.gpr","-XBuild=Release","-Xarch=m68k-amigaos"]
subprocess.run(cmd,cwd=os.pardir)
cmd = ["cranker_windows","-f",input_exe,"-o",os.path.join(output_dir,exe)]
subprocess.run(cmd)
#cmd = ["exe2adf","--input",exe,"--label","Bagman","--adf","bagman.adf","-d",data_dir]
#subprocess.run(cmd,cwd=output_dir)
os.startfile(output_dir)
